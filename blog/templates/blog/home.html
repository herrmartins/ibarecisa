{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- User info para JS -->
  <div id="user-info" class="hidden" comment-author-id="{% if request.user.is_authenticated %}{{ request.user.id }}{% else %}null{% endif %}"></div>

  <!-- Posts Container -->
  <div id="posts-container" class="space-y-6">
    {% for post in posts %}
    <article class="blog-card group">
      <!-- Card Header -->
      <div class="blog-card-header">
        <h3 class="blog-card-title">{{ post.title }}</h3>
        <div class="flex items-center gap-3 flex-wrap">
          <p class="blog-card-meta">
            Por {{ post.author.first_name }} {{ post.author.last_name }} em {{ post.created|date:"d/m/Y" }}
            {% if post.created != post.modified %}
              <span class="blog-card-updated">• Atualizado em {{ post.modified|date:"d/m/Y" }}</span>
            {% endif %}
          </p>
          {% if post.author == request.user %}
          <a href="{% url 'blog:edit' post.id %}" class="blog-edit-btn">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2h2.828l8.586-8.586z"/></svg>
            Editar
          </a>
          {% endif %}
        </div>
      </div>

      <!-- Card Body -->
      <div class="blog-card-body">
        <div class="blog-card-content">{{ post.content|safe }}</div>
      </div>

      <!-- Card Footer -->
      <div class="blog-card-footer">
        <!-- Categories -->
        <div class="flex-1">
          <span class="text-sm text-slate-500">Categorias:</span>
          <div class="flex flex-wrap gap-2 mt-1">
            {% for category in post.categories.all %}
              <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-primary-100 text-primary-700">
                {{ category.name }}
              </span>
            {% empty %}
              <span class="text-sm text-slate-400 italic">Não categorizado</span>
            {% endfor %}
          </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center gap-3">
          <!-- Like Button com Alpine.js -->
          <div class="flex items-center gap-2" x-data="{
            liked: {% if user in post.likes.all %}true{% else %}false{% endif %},
            likeCount: {{ post.likes.count }},
            likers: [
              {% for liker in post.likes.all|slice:":5" %}
              {
                id: {{ liker.id }},
                first_name: '{{ liker.first_name }}',
                last_name: '{{ liker.last_name }}',
                profile_image: {% if liker.profile_image %}'{{ liker.profile_image.url }}'{% else %}null{% endif %}
              }{% if not forloop.last %},{% endif %}
              {% endfor %}
            ],
            hasMoreLikers: {{ post.likes.count }} > 5,
            loading: false,
            postId: {{ post.id }},
            isAuthenticated: {% if user.is_authenticated %}true{% else %}false{% endif %},

            async toggleLike() {
              if (!this.isAuthenticated || this.loading) return;
              this.loading = true;

              try {
                const response = await fetch(`/blog/like/${this.postId}/`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || this.getCookie('csrftoken')
                  }
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                this.liked = data.liked;
                this.likeCount = data.like_count;
                this.likers = data.likers;
                this.hasMoreLikers = data.has_more_likers;

              } catch (error) {
                console.error('Error toggling like:', error);
              } finally {
                this.loading = false;
              }
            },

            getCookie(name) {
              const value = `; ${document.cookie}`;
              const parts = value.split(`; ${name}=`);
              if (parts.length === 2) return parts.pop().split(';').shift();
              return null;
            }
          }">
            {% if user.is_authenticated %}
            <button
              @click="toggleLike"
              :disabled="loading"
              class="blog-like-btn"
              :class="{ 'blog-like-btn-liked': liked, 'blog-like-btn-loading': loading }"
            >
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" :fill="liked ? 'currentColor' : 'none'" stroke="currentColor" stroke-width="2"/>
              </svg>
              <span class="font-semibold" x-text="likeCount"></span>
            </button>
            {% else %}
            <button disabled class="blog-like-btn blog-like-btn-disabled">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
              <span class="font-semibold">{{ post.likes.count }}</span>
            </button>
            {% endif %}

            <!-- Likers Avatars -->
            <div class="flex items-center -space-x-2" x-show="likers.length > 0" x-transition>
              <template x-for="liker in likers.slice(0, 5)" :key="liker.id">
                <img
                  :src="liker.profile_image || '/static/img/user.png'"
                  :alt="liker.first_name"
                  class="w-6 h-6 rounded-full ring-2 ring-white"
                  :title="`${liker.first_name} ${liker.last_name}`"
                >
              </template>
              <span
                x-show="hasMoreLikers"
                class="text-xs text-slate-500 font-medium"
                x-text="'+' + (likeCount - 5)"
              ></span>
            </div>
          </div>

          <!-- Comment Toggle -->
          <button class="blog-comment-toggle" data-post-id="{{ post.id }}">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 16h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
          </button>
        </div>
      </div>

      <!-- Comments Container -->
      <div class="blog-comments-container hidden" id="comments-{{ post.id }}"></div>

      <!-- Comment Form -->
      <div class="blog-comment-form hidden" id="form-{{ post.id }}">
        {% if not user.is_authenticated %}
        <div class="blog-login-notice">
          <svg class="w-5 h-5 text-info-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          <span><strong>Faça login</strong> para adicionar seu comentário e participar da discussão.</span>
        </div>
        {% else %}
        <div class="flex gap-4">
          <!-- Avatar -->
          <div class="flex-shrink-0">
            {% if user.profile_image %}
              <img src="{{ user.profile_image.url }}" alt="{{ user.username }}" class="w-12 h-12 rounded-full ring-2 ring-primary-200">
            {% else %}
              <div class="w-12 h-12 rounded-full bg-gradient-to-br from-primary-500 to-secondary-500 ring-2 ring-primary-200 flex items-center justify-center">
                <span class="text-white font-bold text-lg">{{ user.first_name|first|upper }}</span>
              </div>
            {% endif %}
          </div>

          <!-- Form -->
          <div class="flex-1">
            <div class="relative">
              <textarea
                id="comment-{{ post.id }}"
                class="blog-textarea"
                rows="3"
                placeholder="Compartilhe seus pensamentos..."
                required
              ></textarea>
            </div>
            <div class="flex items-center justify-between mt-3">
              <span class="text-xs text-slate-400 flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Comentários são moderados
              </span>
              <button type="button" id="sendComment-{{ post.id }}" data-post-id="{{ post.id }}" class="blog-submit-btn">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                <span class="ml-1">Postar</span>
              </button>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </article>
    {% endfor %}
  </div>

  <!-- Pagination -->
  {% if is_paginated and paginator.num_pages > 1 %}
  <nav class="mt-8" aria-label="Navegação do blog">
    <ul class="flex justify-center items-center gap-2">
      {% if page_obj.has_previous %}
      <li>
        <a href="?page=1" class="blog-pagination-link">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/></svg>
          Primeira
        </a>
      </li>
      <li>
        <a href="?page={{ page_obj.previous_page_number }}" class="blog-pagination-link">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
          Anterior
        </a>
      </li>
      {% endif %}

      <li class="blog-pagination-current">
        Página {{ page_obj.number }} de {{ paginator.num_pages }}
      </li>

      {% if page_obj.has_next %}
      <li>
        <a href="?page={{ page_obj.next_page_number }}" class="blog-pagination-link">
          Próxima
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
        </a>
      </li>
      <li>
        <a href="?page={{ paginator.num_pages }}" class="blog-pagination-link">
          Última
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l14 14"/></svg>
        </a>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<!-- Scripts -->
<script src="{% static 'js/get_cookie.js' %}"></script>
<script src="{% static 'js/comment_fetch.js' %}"></script>
<script src="{% static 'js/post_comment.js' %}"></script>
<script src="{% static 'js/add_comment_to_html.js' %}"></script>
<script src="{% static 'js/comment_edit.js' %}"></script>

{% endblock %}
