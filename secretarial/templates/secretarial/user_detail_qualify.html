{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-gradient-to-b from-slate-50 to-white">
  <!-- Header Section -->
  <div class="minutes-list-header relative">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 relative z-10">
      <!-- Back Button -->
      <div class="mb-6">
        <a href="{% url 'secretarial:users-qualifying' %}" class="inline-flex items-center gap-2 text-white/80 hover:text-white transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          Voltar para Usuários
        </a>
      </div>

      <div class="text-center mb-4">
        <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">
          Dados do Usuário
        </h1>
        <p class="text-white/90 text-lg">
          Gerencie funções e aprovações de acesso
        </p>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- User Info Card -->
    <div class="minute-create-editor-card mb-6">
      <div class="flex items-center gap-4 p-6 bg-gradient-to-r from-primary-50 to-purple-50 rounded-xl mb-6">
        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-primary-500 to-purple-600 flex items-center justify-center text-white font-bold text-2xl">
          {{ user_object.first_name|first }}{{ user_object.last_name|first }}
        </div>
        <div>
          <h2 class="text-xl font-bold text-slate-800">{{ user_object.first_name }} {{ user_object.last_name }}</h2>
          <p class="text-slate-600">{{ user_object.email|default:"Sem e-mail cadastrado" }}</p>
          {% if user_object.phone_number %}
          <p class="text-sm text-slate-500 flex items-center gap-1 mt-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
            </svg>
            {{ user_object.phone_number }}
          </p>
          {% endif %}
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6">
        <!-- Approval Toggle -->
        <div class="space-y-4">
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
            </svg>
            <h3 class="font-semibold text-slate-800">Aprovação de Acesso</h3>
          </div>
          <div id="approval-toggle" onclick="toggleApproval({{ user_object.id }})"
               class="cursor-pointer {% if user_object.is_approved %}bg-green-100{% else %}bg-yellow-100{% endif %} hover:opacity-80 transition-opacity p-4 rounded-lg border {% if user_object.is_approved %}border-green-200{% else %}border-yellow-200{% endif %}">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full {% if user_object.is_approved %}bg-green-500{% else %}bg-yellow-500{% endif %} flex items-center justify-center">
                {% if user_object.is_approved %}
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
                {% else %}
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                </svg>
                {% endif %}
              </div>
              <div>
                <p class="font-semibold {% if user_object.is_approved %}text-green-700{% else %}text-yellow-700{% endif %}">
                  {% if user_object.is_approved %}Aprovado{% else %}Pendente{% endif %}
                </p>
                <p class="text-xs {% if user_object.is_approved %}text-green-600{% else %}text-yellow-600{% endif %}">
                  Clique para alternar
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Function Toggles -->
        <div class="space-y-4">
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <h3 class="font-semibold text-slate-800">Funções</h3>
          </div>

          <!-- Aviso para usuários que não podem ter funções -->
          <div id="functions-warning" class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800" style="display: {% if user_object.type == "CONGREGATED" or user_object.type == "SIMPLE_USER" or user_object.type == "REGULAR" or not user_object.is_approved %}block{% else %}none{% endif %};">
            <p class="flex items-center gap-2">
              <svg class="w-4 h-4 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>
              <span id="functions-warning-text">
                {% if not user_object.is_approved %}
                  Aprove o usuário para alterar funções
                {% elif user_object.type == "REGULAR" %}
                  Membros não podem ter funções. Altere o tipo para Equipe ou Contratado.
                {% else %}
                  Esse usuário não pode ter função, pois não é membro
                {% endif %}
              </span>
            </p>
          </div>

          <!-- Botões de funções (escondidos quando não permitido) -->
          <div id="functions-buttons" class="space-y-2" style="display: {% if user_object.type == "CONGREGATED" or user_object.type == "SIMPLE_USER" or user_object.type == "REGULAR" or not user_object.is_approved %}none{% else %}block{% endif %};">
            <!-- Pastor Toggle -->
            <button onclick="setFunction({{ user_object.id }}, 'pastor', {{ user_object.is_pastor|lower }})"
                    class="w-full flex items-center gap-3 p-3 rounded-lg border transition-colors {% if user_object.is_pastor %}bg-purple-50 border-purple-300{% else %}bg-slate-50 border-slate-200 hover:bg-slate-100{% endif %}">
              <div class="w-8 h-8 rounded-full {% if user_object.is_pastor %}bg-purple-500{% else %}bg-slate-300{% endif %} flex items-center justify-center">
                <svg class="w-4 h-4 {% if user_object.is_pastor %}text-white{% else %}text-slate-500{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
              </div>
              <span class="font-medium {% if user_object.is_pastor %}text-purple-700{% else %}text-slate-700{% endif %}">Pastor</span>
              {% if user_object.is_pastor %}
              <svg class="w-5 h-5 text-purple-500 ml-auto" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              {% endif %}
            </button>

            <!-- Secretário Toggle -->
            <button onclick="setFunction({{ user_object.id }}, 'secretary', {{ user_object.is_secretary|lower }})"
                    class="w-full flex items-center gap-3 p-3 rounded-lg border transition-colors {% if user_object.is_secretary %}bg-blue-50 border-blue-300{% else %}bg-slate-50 border-slate-200 hover:bg-slate-100{% endif %}">
              <div class="w-8 h-8 rounded-full {% if user_object.is_secretary %}bg-blue-500{% else %}bg-slate-300{% endif %} flex items-center justify-center">
                <svg class="w-4 h-4 {% if user_object.is_secretary %}text-white{% else %}text-slate-500{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                </svg>
              </div>
              <span class="font-medium {% if user_object.is_secretary %}text-blue-700{% else %}text-slate-700{% endif %}">Secretário</span>
              {% if user_object.is_secretary %}
              <svg class="w-5 h-5 text-blue-500 ml-auto" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              {% endif %}
            </button>

            <!-- Tesoureiro Toggle -->
            <button onclick="setFunction({{ user_object.id }}, 'treasurer', {{ user_object.is_treasurer|lower }})"
                    class="w-full flex items-center gap-3 p-3 rounded-lg border transition-colors {% if user_object.is_treasurer %}bg-green-50 border-green-300{% else %}bg-slate-50 border-slate-200 hover:bg-slate-100{% endif %}">
              <div class="w-8 h-8 rounded-full {% if user_object.is_treasurer %}bg-green-500{% else %}bg-slate-300{% endif %} flex items-center justify-center">
                <svg class="w-4 h-4 {% if user_object.is_treasurer %}text-white{% else %}text-slate-500{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                </svg>
              </div>
              <span class="font-medium {% if user_object.is_treasurer %}text-green-700{% else %}text-slate-700{% endif %}">Tesoureiro</span>
              {% if user_object.is_treasurer %}
              <svg class="w-5 h-5 text-green-500 ml-auto" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              {% endif %}
            </button>
          </div>
        </div>

        <!-- User Type Selector -->
        <div class="space-y-4">
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"/>
            </svg>
            <h3 class="font-semibold text-slate-800">Tipo de Usuário</h3>
          </div>
          {% if not user_object.is_approved %}
          <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800">
            <p class="flex items-center gap-2">
              <svg class="w-4 h-4 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>
              Aprove o usuário para alterar tipo
            </p>
          </div>
          {% else %}
          <div class="space-y-2">
            <button id="btn-type-regular" onclick="setUserType({{ user_object.id }}, 'REGULAR')"
                    class="w-full flex items-center gap-3 p-3 rounded-lg border transition-colors {% if user_object.type == 'REGULAR' %}bg-slate-200 border-slate-400{% else %}bg-slate-50 border-slate-200 hover:bg-slate-100{% endif %}">
              <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
              </svg>
              <span class="font-medium type-text">Membro</span>
              <svg class="w-5 h-5 text-slate-500 ml-auto type-check hidden" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
            </button>

            <button id="btn-type-staff" onclick="setUserType({{ user_object.id }}, 'STAFF')"
                    class="w-full flex items-center gap-3 p-3 rounded-lg border transition-colors {% if user_object.type == 'STAFF' %}bg-orange-50 border-orange-300{% else %}bg-slate-50 border-slate-200 hover:bg-slate-100{% endif %}">
              <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 100-14 7 7 0 000 14zm0 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span class="font-medium type-text">Equipe</span>
              <svg class="w-5 h-5 text-orange-500 ml-auto type-check hidden" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
            </button>

            <button id="btn-type-worker" onclick="setUserType({{ user_object.id }}, 'ONLY_WORKER')"
                    class="w-full flex items-center gap-3 p-3 rounded-lg border transition-colors {% if user_object.type == 'ONLY_WORKER' %}bg-amber-50 border-amber-300{% else %}bg-slate-50 border-slate-200 hover:bg-slate-100{% endif %}">
              <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              <span class="font-medium type-text">Contratado</span>
              <svg class="w-5 h-5 text-amber-500 ml-auto type-check hidden" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
            </button>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Current Status Card -->
    <div class="minute-create-editor-card">
      <div class="flex items-center gap-3 mb-4">
        <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <h3 class="font-semibold text-slate-800">Status Atual</h3>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="status-cards">
        <div class="text-center p-4 bg-slate-50 rounded-lg">
          <p class="text-xs text-slate-500 mb-1">Tipo</p>
          <p class="font-semibold text-slate-800" id="status-type">{{ user_object.get_type_display|default:"—" }}</p>
        </div>
        <div class="text-center p-4 rounded-lg" id="status-approval-container">
          <p class="text-xs text-slate-500 mb-1">Aprovação</p>
          <p class="font-semibold" id="status-approval">
            {% if user_object.is_approved %}Aprovado{% else %}Pendente{% endif %}
          </p>
        </div>
        <div class="text-center p-4 bg-purple-50 rounded-lg" id="status-pastor-container">
          <p class="text-xs text-slate-500 mb-1">Pastor</p>
          <p class="font-semibold" id="status-pastor">
            {% if user_object.is_pastor %}Sim{% else %}Não{% endif %}
          </p>
        </div>
        <div class="text-center p-4 bg-blue-50 rounded-lg" id="status-secretary-container">
          <p class="text-xs text-slate-500 mb-1">Secretário</p>
          <p class="font-semibold" id="status-secretary">
            {% if user_object.is_secretary %}Sim{% else %}Não{% endif %}
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const userId = {{ user_object.id }};
let isApproved = {{ user_object.is_approved|lower }};
let userType = "{{ user_object.type }}";

// Mapeamento de valores internos para valores do Django
const typeToDjango = {
    'REGULAR': 'REGULAR',
    'STAFF': 'EQUIPE',
    'ONLY_WORKER': 'TRABALHADOR',
    'CONGREGATED': 'CONGREGADO',
    'SIMPLE_USER': 'USUARIO'
};

const djangoToType = {
    'REGULAR': 'REGULAR',
    'EQUIPE': 'STAFF',
    'TRABALHADOR': 'ONLY_WORKER',
    'CONGREGADO': 'CONGREGATED',
    'USUARIO': 'SIMPLE_USER'
};

// Normalizar o tipo vindo do template Django para valor interno
if (djangoToType[userType]) {
    userType = djangoToType[userType];
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

function updateFunctionsUI() {
    const warning = document.getElementById('functions-warning');
    const warningText = document.getElementById('functions-warning-text');
    const buttons = document.getElementById('functions-buttons');

    // Se não aprovado, REGULAR, CONGREGATED ou SIMPLE_USER: mostrar aviso, esconder botões
    const cannotHaveFunctions = !isApproved || userType === 'REGULAR' || userType === 'CONGREGATED' || userType === 'SIMPLE_USER';

    if (cannotHaveFunctions) {
        warning.style.display = 'block';
        buttons.style.display = 'none';

        // Atualizar texto do aviso
        if (!isApproved) {
            warningText.textContent = 'Aprove o usuário para alterar funções';
        } else if (userType === 'REGULAR') {
            warningText.textContent = 'Membros não podem ter funções. Altere o tipo para Equipe ou Contratado.';
        } else {
            warningText.textContent = 'Esse usuário não pode ter função, pois não é membro';
        }
    } else {
        warning.style.display = 'none';
        buttons.style.display = 'block';
    }
}

function updateTypeButtonsUI() {
    const typeConfigs = {
        'REGULAR': { button: 'btn-type-regular', bgClass: 'bg-slate-200 border-slate-400', textClass: 'text-slate-800', checkColor: 'text-slate-500' },
        'STAFF': { button: 'btn-type-staff', bgClass: 'bg-orange-50 border-orange-300', textClass: 'text-orange-700', checkColor: 'text-orange-500' },
        'ONLY_WORKER': { button: 'btn-type-worker', bgClass: 'bg-amber-50 border-amber-300', textClass: 'text-amber-700', checkColor: 'text-amber-500' }
    };

    // Reset all buttons
    Object.values(typeConfigs).forEach(config => {
        const btn = document.getElementById(config.button);
        if (btn) {
            btn.className = `w-full flex items-center gap-3 p-3 rounded-lg border transition-colors bg-slate-50 border-slate-200 hover:bg-slate-100`;
            const textSpan = btn.querySelector('.type-text');
            if (textSpan) textSpan.className = 'font-medium type-text text-slate-700';
            const checkSvg = btn.querySelector('.type-check');
            if (checkSvg) checkSvg.classList.add('hidden');
        }
    });

    // Highlight selected type
    const config = typeConfigs[userType];
    if (config) {
        const btn = document.getElementById(config.button);
        if (btn) {
            btn.className = `w-full flex items-center gap-3 p-3 rounded-lg border transition-colors ${config.bgClass}`;
            const textSpan = btn.querySelector('.type-text');
            if (textSpan) textSpan.className = `font-medium type-text ${config.textClass}`;
            const checkSvg = btn.querySelector('.type-check');
            if (checkSvg) {
                checkSvg.classList.remove('hidden');
                checkSvg.className = `w-5 h-5 ml-auto type-check ${config.checkColor}`;
            }
        }
    }
}

// Initialize UI on page load
document.addEventListener('DOMContentLoaded', function() {
    updateFunctionsUI();
    updateTypeButtonsUI();
});

async function toggleApproval(id) {
    event.preventDefault();

    try {
        const formData = new FormData();
        formData.append('is_approved', !isApproved);
        formData.append('submit', 'submit');

        const response = await fetch(`/user/update/function/${id}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        });

        if (response.ok) {
            isApproved = !isApproved;
            updateUI();
            showNotification(isApproved ? 'Usuário aprovado!' : 'Aprovação removida!', 'success');
        } else {
            showNotification('Erro ao alterar status', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Erro ao alterar status', 'error');
    }
}

async function setFunction(id, funcType, currentValue) {
    event.preventDefault();

    if (!isApproved) {
        showNotification('Usuário pendente não pode ter funções alteradas', 'error');
        return;
    }

    try {
        const formData = new FormData();
        formData.append('is_' + funcType, !currentValue);
        formData.append('submit', 'submit');

        const response = await fetch(`/user/update/function/${id}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        });

        if (response.ok) {
            location.reload();
        } else {
            showNotification('Erro ao alterar função', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Erro ao alterar função', 'error');
    }
}

async function setUserType(id, newType) {
    event.preventDefault();

    if (!isApproved) {
        showNotification('Usuário pendente não pode ter tipo alterado', 'error');
        return;
    }

    try {
        const formData = new FormData();
        // Converter valor interno para valor do Django
        formData.append('type', typeToDjango[newType]);
        formData.append('submit', 'submit');

        const response = await fetch(`/user/update/${id}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        });

        if (response.ok) {
            userType = newType;
            updateFunctionsUI();
            updateTypeButtonsUI();
            showNotification('Tipo alterado com sucesso!', 'success');
        } else {
            const errorData = await response.json();
            showNotification(errorData.error || 'Erro ao alterar tipo', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Erro ao alterar tipo', 'error');
    }
}

function updateUI() {
    // Update approval toggle
    const toggle = document.getElementById('approval-toggle');
    if (isApproved) {
        toggle.className = 'cursor-pointer bg-green-100 hover:opacity-80 transition-opacity p-4 rounded-lg border border-green-200';
        toggle.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div>
                    <p class="font-semibold text-green-700">Aprovado</p>
                    <p class="text-xs text-green-600">Clique para alternar</p>
                </div>
            </div>
        `;
    } else {
        toggle.className = 'cursor-pointer bg-yellow-100 hover:opacity-80 transition-opacity p-4 rounded-lg border border-yellow-200';
        toggle.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-yellow-500 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div>
                    <p class="font-semibold text-yellow-700">Pendente</p>
                    <p class="text-xs text-yellow-600">Clique para alternar</p>
                </div>
            </div>
        `;
    }

    // Update functions UI based on approval
    updateFunctionsUI();

    // Update status card
    const approvalContainer = document.getElementById('status-approval-container');
    const approvalText = document.getElementById('status-approval');
    if (isApproved) {
        approvalContainer.className = 'text-center p-4 bg-green-50 rounded-lg';
        approvalText.className = 'font-semibold text-green-700';
        approvalText.textContent = 'Aprovado';
    } else {
        approvalContainer.className = 'text-center p-4 bg-yellow-50 rounded-lg';
        approvalText.className = 'font-semibold text-yellow-700';
        approvalText.textContent = 'Pendente';
    }
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg text-white text-sm z-50 transition-opacity ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}
</script>
{% endblock %}
