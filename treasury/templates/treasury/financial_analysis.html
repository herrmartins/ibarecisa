{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/treasury.css' %}">
<link rel="stylesheet" href="{% static 'css/financial_charts.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js@10.2.0/public/assets/styles/choices.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js@10.2.0/public/assets/scripts/choices.min.js"></script>

<div class="welcome-section py-5">
  <div class="container">
    <div class="text-center mb-5">
      <h1 class="display-4 fw-bold text-primary mb-4">Análise Financeira</h1>
      <p class="lead text-muted mb-4">Análise avançada e insights inteligentes dos dados financeiros</p>
    </div>

  <!-- Filtros e Insights ocupando toda a largura da página -->
  <div class="row g-4 mb-4">
    <div class="col-12">
      <div class="row g-4">
        <!-- Filtros Avançados -->
        <div class="col-lg-6 col-md-12">
          <div class="card h-100">
            <div class="card-header">
              <h5 class="card-title mb-0">Filtros Avançados</h5>
            </div>
            <div class="card-body">
              <form method="get">
                <!-- Primeira linha: Campos principais -->
                <div class="row g-2 mb-3">
                  <div class="col-6">
                    <label for="start_date" class="form-label">Data Inicial</label>
                    <input type="date" class="form-control" id="start_date" name="start_date"
                           value="{{ start_date }}" required>
                  </div>
                  <div class="col-6">
                    <label for="end_date" class="form-label">Data Final</label>
                    <input type="date" class="form-control" id="end_date" name="end_date"
                           value="{{ end_date }}" required>
                  </div>
                </div>

                <!-- Segunda linha: Tipo e Valores -->
                <div class="row g-2 mb-3">
                  <div class="col-4">
                    <label for="type" class="form-label">Tipo</label>
                    <select class="form-select" id="type" name="type">
                      <option value="" {% if not transaction_type %}selected{% endif %}>Todas</option>
                      <option value="positive" {% if transaction_type == 'positive' %}selected{% endif %}>Entradas</option>
                      <option value="negative" {% if transaction_type == 'negative' %}selected{% endif %}>Saídas</option>
                    </select>
                  </div>
                  <div class="col-4">
                    <label for="min_amount" class="form-label">Valor Mínimo</label>
                    <input type="number" step="0.01" class="form-control" id="min_amount" name="min_amount"
                           value="{{ min_amount }}" placeholder="0.00">
                  </div>
                  <div class="col-4">
                    <label for="max_amount" class="form-label">Valor Máximo</label>
                    <input type="number" step="0.01" class="form-control" id="max_amount" name="max_amount"
                           value="{{ max_amount }}" placeholder="0.00">
                  </div>
                </div>

                <!-- Terceira linha: Select de categorias -->
                <div class="row g-2 mb-3">
                  <div class="col-12">
                    <label for="categories" class="form-label">Categorias</label>
                    <select multiple class="form-select" id="categories" name="categories" style="min-height: 120px;">
                      {% for category in available_categories %}
                      <option value="{{ category }}" {% if category in selected_categories %}selected{% endif %}>
                        {{ category }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                </div>

                <!-- Quarta linha: Botão Aplicar -->
                <div class="row g-2">
                  <div class="col-12 text-center">
                    <button type="submit" class="btn btn-primary px-5">Aplicar Filtros</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Insights de AI -->
        <div class="col-lg-6 col-md-12">
          <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">Insights de IA</h5>
              <button id="generateInsightsBtn" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-brain"></i> Gerar Novamente
              </button>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
               {% if ai_insights %}
                 <div class="mb-2 text-muted small">
                   <i class="fas fa-clock"></i> Gerado em: {{ insights_generated_at|date:"d/m/Y H:i" }}
                 </div>
               {% endif %}
               <div id="insightsContent">
                {% if ai_insights %}
                  <div class="alert alert-info">
                    {{ ai_insights|linebreaks }}
                  </div>
                {% else %}
                  <div class="text-center text-muted">
                    <p>Clique em "Gerar Novamente" para obter insights baseados nos dados filtrados.</p>
                  </div>
                {% endif %}
              </div>
              <div id="insightsLoading" class="text-center" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Gerando insights...</span>
                </div>
                <p class="mt-2">Gerando insights com IA...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Resumo do Período - Largura Total -->
  <div class="row g-3 mb-3">
    <div class="col-12">
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="card-title mb-0">Resumo do Período</h5>
        </div>
        <div class="card-body">
          <div class="row g-3 justify-content-center">
            <div class="col-12 col-sm-6 col-md-3">
              <div class="p-3 bg-success text-white rounded text-center stat-card">
                <div class="mb-2">Total Receitas</div>
                <div class="h5 fw-light">R$ {{ total_revenue|floatformat:2 }}</div>
              </div>
            </div>
            <div class="col-12 col-sm-6 col-md-3">
              <div class="p-3 bg-danger text-white rounded text-center stat-card">
                <div class="mb-2">Total Despesas</div>
                <div class="h5 fw-light">R$ {{ total_expenses|floatformat:2 }}</div>
              </div>
            </div>
            <div class="col-12 col-sm-6 col-md-3">
              <div class="p-3 bg-primary text-white rounded text-center stat-card">
                <div class="mb-2">Saldo Líquido</div>
                <div class="h5 fw-light">R$ {{ net_balance|floatformat:2 }}</div>
              </div>
            </div>
            <div class="col-12 col-sm-6 col-md-3">
              <div class="p-3 bg-info text-white rounded text-center stat-card">
                <div class="mb-2">Transações</div>
                <div class="h5 fw-light">{{ transaction_count }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista de Transações - Largura Total -->
  <div class="row g-3 mb-3">
    <div class="col-12">
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="card-title mb-0">Transações Filtradas</h5>
        </div>
        <div class="card-body p-0">
          {% if paginated_transactions %}
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Data</th>
                    <th>Descrição</th>
                    <th>Categoria</th>
                    <th class="text-end">Valor</th>
                  </tr>
                </thead>
                <tbody>
                  {% for transaction in paginated_transactions %}
                  <tr>
                    <td>{{ transaction.date|date:"d/m/Y" }}</td>
                    <td>{{ transaction.description|truncatechars:30 }}</td>
                    <td>
                      {% if transaction.category %}
                        {{ transaction.category.name }}
                      {% else %}
                        Sem Categoria
                      {% endif %}
                    </td>
                    <td class="text-end">
                      <span class="{% if transaction.is_positive %}text-success{% else %}text-danger{% endif %}">
                        {% if transaction.is_positive %}+{% else %}-{% endif %}R$ {{ transaction.amount|floatformat:2 }}
                      </span>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <!-- Paginação -->
            {% if paginated_transactions.has_other_pages %}
            <div class="card-footer">
              <nav aria-label="Navegação de páginas">
                <ul class="pagination pagination-sm justify-content-center mb-0">
                  {% if paginated_transactions.has_previous %}
                    <li class="page-item">
                      <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ paginated_transactions.previous_page_number }}">Anterior</a>
                    </li>
                  {% endif %}

                  {% for num in paginated_transactions.paginator.page_range %}
                    {% if paginated_transactions.number == num %}
                      <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% elif num > paginated_transactions.number|add:'-3' and num < paginated_transactions.number|add:'3' %}
                      <li class="page-item">
                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                      </li>
                    {% endif %}
                  {% endfor %}

                  {% if paginated_transactions.has_next %}
                    <li class="page-item">
                      <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ paginated_transactions.next_page_number }}">Próximo</a>
                    </li>
                  {% endif %}
                </ul>
              </nav>
            </div>
            {% endif %}
          {% else %}
            <div class="text-center text-muted p-4">
              <p>Nenhuma transação encontrada para os filtros aplicados.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Top Categorias - Largura Total -->
  <div class="row g-3 mb-3">
    <div class="col-12">
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="card-title mb-0">Top 5 Categorias</h5>
        </div>
        <div class="card-body">
          <div class="row g-3 justify-content-center">
            {% for category, amount in top_categories %}
            <div class="col-12 col-sm-6 col-md-4 col-lg-2">
              <div class="p-3 bg-secondary text-white rounded text-center stat-card">
                <div class="mb-2">{{ category|truncatechars:15 }}</div>
                <div class="h5 fw-light" id="category-amount-{{ forloop.counter }}">R$ {{ amount|floatformat:2 }}</div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficos - Lado a Lado -->
  <div class="row g-3">
    <!-- Gráfico de Distribuição por Categoria -->
    <div class="col-12 col-lg-6">
      <div class="card chart-container">
        <div class="card-header">
          <h5 class="card-title mb-0">Distribuição por Categoria</h5>
        </div>
        <div class="card-body">
          <canvas id="categoryChart" width="400" height="300"></canvas>
        </div>
      </div>
    </div>

    <!-- Gráfico de Linhas: Receitas vs Despesas -->
    <div class="col-12 col-lg-6">
      <div class="card chart-container">
        <div class="card-header">
          <h5 class="card-title mb-0">Evolução Financeira Mensal</h5>
          <small class="text-muted">Receitas, Despesas e Saldo Líquido</small>
        </div>
        <div class="card-body">
          <canvas id="monthlyChart" width="400" height="300"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Função para formatar valores monetários em reais brasileiros
  function formatCurrency(value) {
    return new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL',
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).format(value);
  }

  // Inicializar Choices.js para o select de categorias
  document.addEventListener('DOMContentLoaded', function() {
    const categoriesSelect = document.getElementById('categories');
    const choices = new Choices(categoriesSelect, {
      removeItemButton: true,
      placeholder: true,
      placeholderValue: 'Selecione categorias...',
      searchPlaceholderValue: 'Buscar categorias...',
      noResultsText: 'Nenhuma categoria encontrada',
      noChoicesText: 'Nenhuma categoria disponível',
      itemSelectText: 'Pressione Enter para selecionar',
      maxItemCount: 10,
      searchEnabled: true,
      searchChoices: true,
      shouldSort: false,
      classNames: {
        containerOuter: 'choices',
        containerInner: 'choices__inner',
        input: 'choices__input',
        inputCloned: 'choices__input--cloned',
        list: 'choices__list',
        listItems: 'choices__list--multiple',
        listSingle: 'choices__list--single',
        listDropdown: 'choices__list--dropdown',
        item: 'choices__item',
        itemSelectable: 'choices__item--selectable',
        itemDisabled: 'choices__item--disabled',
        itemChoice: 'choices__item--choice',
        placeholder: 'choices__placeholder',
        group: 'choices__group',
        groupHeading: 'choices__heading',
        button: 'choices__button',
        activeState: 'is-active',
        focusState: 'is-focused',
        openState: 'is-open',
        disabledState: 'is-disabled',
        highlightedState: 'is-highlighted',
        selectedState: 'is-selected',
        flippedState: 'is-flipped'
      }
    });
  });

  // Formatar valores das categorias no carregamento da página
  document.addEventListener('DOMContentLoaded', function() {
    // Formatar valores dos cards de estatísticas
    const statCards = document.querySelectorAll('.stat-card .h5');
    statCards.forEach(card => {
      const text = card.textContent;
      if (text.includes('R$')) {
        const value = parseFloat(text.replace('R$', '').replace(',', '.').trim());
        if (!isNaN(value)) {
          card.textContent = formatCurrency(value).replace('R$', 'R$ ');
        }
      }
    });

    // Formatar valores das top categorias
    const categoryAmounts = document.querySelectorAll('[id^="category-amount-"]');
    categoryAmounts.forEach(element => {
      const text = element.textContent;
      if (text.includes('R$')) {
        const value = parseFloat(text.replace('R$', '').replace(/\./g, '').replace(',', '.').trim());
        if (!isNaN(value)) {
          element.textContent = formatCurrency(value).replace('R$', 'R$ ');
        }
      } else {
        // Se não tem R$, tenta formatar como número puro
        const value = parseFloat(text.replace(/\./g, '').replace(',', '.').trim());
        if (!isNaN(value)) {
          element.textContent = formatCurrency(value).replace('R$', 'R$ ');
        }
      }
    });

    // Formatar valores na tabela de transações
    const transactionAmounts = document.querySelectorAll('td.text-end span');
    transactionAmounts.forEach(span => {
      const text = span.textContent;
      const isPositive = text.includes('+');
      const isNegative = text.includes('-');
      const valueText = text.replace(/[+-]R\$\s*/, '').replace(/\./g, '').replace(',', '.').trim();
      const value = parseFloat(valueText);

      if (!isNaN(value)) {
        const formattedValue = formatCurrency(value).replace('R$', 'R$ ');
        span.innerHTML = `${isPositive ? '+' : isNegative ? '-' : ''}${formattedValue}`;
      }
    });
  });

  // Dados dos gráficos passados pela view
  const monthlyData = {{ monthly_data_json|safe }};
  const categoryData = {{ category_data_json|safe }};

  // Configuração do gráfico de linhas mensal
  const ctxMonthly = document.getElementById('monthlyChart').getContext('2d');
  const monthlyChart = new Chart(ctxMonthly, {
    type: 'line',
    data: {
      labels: monthlyData.map(item => item.month),
      datasets: [{
        label: 'Receitas',
        data: monthlyData.map(item => item.revenue),
        borderColor: 'rgb(40, 167, 69)',
        backgroundColor: 'rgba(40, 167, 69, 0.1)',
        tension: 0.1,
        borderWidth: 3,
        pointRadius: 5,
        pointHoverRadius: 7
      }, {
        label: 'Despesas',
        data: monthlyData.map(item => item.expenses),
        borderColor: 'rgb(220, 53, 69)',
        backgroundColor: 'rgba(220, 53, 69, 0.1)',
        tension: 0.1,
        borderWidth: 3,
        pointRadius: 5,
        pointHoverRadius: 7
      }, {
        label: 'Saldo Líquido',
        data: monthlyData.map(item => item.net),
        borderColor: 'rgb(0, 123, 255)',
        backgroundColor: 'rgba(0, 123, 255, 0.1)',
        tension: 0.1,
        borderWidth: 3,
        pointRadius: 5,
        pointHoverRadius: 7
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: 'Evolução Financeira Mensal',
          font: {
            size: 16,
            weight: 'bold'
          }
        },
        legend: {
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20
          }
        },
        tooltip: {
          mode: 'index',
          intersect: false,
          callbacks: {
            label: function(context) {
              let label = context.dataset.label || '';
              if (label) {
                label += ': ';
              }
              label += 'R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2});
              return label;
            }
          }
        }
      },
      scales: {
        x: {
          display: true,
          title: {
            display: true,
            text: 'Mês/Ano'
          }
        },
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Valor (R$)'
          },
          ticks: {
            callback: function(value) {
              return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            }
          }
        }
      },
      interaction: {
        mode: 'nearest',
        axis: 'x',
        intersect: false
      }
    }
  });

  // Configuração do gráfico de distribuição por categoria
  const ctxCategory = document.getElementById('categoryChart').getContext('2d');
  const categoryChart = new Chart(ctxCategory, {
    type: 'bar',
    data: {
      labels: categoryData.map(item => item.category),
      datasets: [{
        label: 'Valor Total',
        data: categoryData.map(item => item.total),
        backgroundColor: [
          'rgb(255, 99, 132)',
          'rgb(54, 162, 235)',
          'rgb(255, 205, 86)',
          'rgb(75, 192, 192)',
          'rgb(153, 102, 255)',
          'rgb(255, 159, 64)',
          'rgb(199, 199, 199)',
          'rgb(83, 102, 255)',
          'rgb(255, 99, 255)',
          'rgb(99, 255, 132)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 15
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              let label = context.label || '';
              if (label) {
                label += ': ';
              }
              label += 'R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2});
              return label;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            }
          }
        }
      }
    }
  });

  // Função para gerar insights de IA
  document.getElementById('generateInsightsBtn').addEventListener('click', function() {
    const form = document.querySelector('form');
    const formData = new FormData(form);
    const params = new URLSearchParams();

    for (let [key, value] of formData.entries()) {
      if (key === 'categories') {
        params.append(key, value);
      } else {
        params.set(key, value);
      }
    }
    params.set('action', 'generate_insights');

    document.getElementById('insightsContent').style.display = 'none';
    document.getElementById('insightsLoading').style.display = 'block';

    fetch(window.location.pathname + '?' + params.toString(), {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      // Criar elemento div para inserir o conteúdo de forma segura
      const contentDiv = document.createElement('div');
      contentDiv.className = 'alert alert-info';

      // Dividir o texto em linhas e criar parágrafos
      const lines = data.insights.split('\n');
      lines.forEach(line => {
        if (line.trim()) {
          const p = document.createElement('p');
          p.className = 'mb-2';
          p.textContent = line.trim();
          contentDiv.appendChild(p);
        }
      });

      document.getElementById('insightsContent').innerHTML = '';
      document.getElementById('insightsContent').appendChild(contentDiv);
      document.getElementById('insightsContent').style.display = 'block';
      document.getElementById('insightsLoading').style.display = 'none';
    })
    .catch(error => {
      console.error('Erro:', error);
      document.getElementById('insightsContent').innerHTML = `
        <div class="alert alert-danger">
          Erro ao gerar insights. Tente novamente.
        </div>
      `;
      document.getElementById('insightsContent').style.display = 'block';
      document.getElementById('insightsLoading').style.display = 'none';
    });
  });
</script>

{% endblock %}