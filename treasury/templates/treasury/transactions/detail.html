{% extends "treasury/base.html" %}

{% load static %}

{% block treasury_content %}
<div class="container mx-auto px-4 py-6 max-w-3xl" x-data="transactionDetail()">
    <!-- Header -->
    <div class="mb-6">
        <a href="{% url 'treasury:transaction-list' %}" class="text-blue-600 hover:text-blue-800">← Voltar para Transações</a>
        <h1 class="text-2xl font-bold text-gray-800 mt-2">Detalhes da Transação</h1>
    </div>

    <!-- Loading -->
    <div x-show="loading" class="flex justify-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>

    <!-- Transaction Detail -->
    <div x-show="!loading && transaction" class="space-y-6">
        <!-- Main Card -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="p-6" :class="{
                'border-l-4 border-green-500': transaction?.is_positive,
                'border-l-4 border-red-500': !transaction?.is_positive
            }">
                <!-- Type Badge -->
                <div class="flex justify-between items-start mb-4">
                    <span class="inline-block px-3 py-1 rounded-full text-sm font-medium" :class="{
                        'bg-green-100 text-green-800': transaction?.is_positive,
                        'bg-red-100 text-red-800': !transaction?.is_positive
                    }" x-text="transaction?.is_positive ? 'Receita' : 'Despesa'"></span>
                    <span x-show="transaction?.transaction_type === 'reversal'" class="inline-block px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium">
                        Estorno
                    </span>
                </div>

                <!-- Amount -->
                <div class="mb-4">
                    <p class="text-4xl font-bold" :class="transaction?.is_positive ? 'text-green-600' : 'text-red-600'"
                       x-text="formatBRL(transaction?.amount)"></p>
                </div>

                <!-- Description -->
                <div class="mb-4">
                    <p class="text-lg text-gray-800" x-text="transaction?.description"></p>
                </div>

                <!-- Details Grid -->
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="text-gray-500">Data</p>
                        <p class="font-medium" x-text="formatDate(transaction?.date)"></p>
                    </div>
                    <div>
                        <p class="text-gray-500">Categoria</p>
                        <p class="font-medium" x-text="transaction.category_name || '-'"></p>
                    </div>
                    <div>
                        <p class="text-gray-500">Período Contábil</p>
                        <p class="font-medium" x-text="transaction?.accounting_period?.month_name + '/' + transaction?.accounting_period?.year || '-'"></p>
                    </div>
                    <div>
                        <p class="text-gray-500">Criado por</p>
                        <p class="font-medium" x-text="transaction?.created_by?.username || '-'"></p>
                    </div>
                    <div>
                        <p class="text-gray-500">Criado em</p>
                        <p class="font-medium" x-text="formatDateTime(transaction?.created_at)"></p>
                    </div>
                    <div x-show="transaction?.updated_at !== transaction?.created_at">
                        <p class="text-gray-500">Atualizado em</p>
                        <p class="font-medium" x-text="formatDateTime(transaction?.updated_at)"></p>
                    </div>
                </div>
            </div>

            <!-- Document -->
            <div x-show="transaction?.acquittance_doc" class="border-t p-4">
                <p class="text-sm text-gray-500 mb-2">Comprovante</p>
                <a :href="transaction?.acquittance_doc" target="_blank" class="text-blue-600 hover:text-blue-800 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                    Ver comprovante
                </a>
            </div>
        </div>

        <!-- Reversal Info -->
        <div x-show="transaction?.reverses" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <p class="text-sm text-yellow-800">
                <strong>Estorno de:</strong> Transação #<span x-text="transaction?.reverses"></span>
            </p>
        </div>

        <!-- Status & Actions -->
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex flex-wrap gap-4 items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">Status do Período</p>
                    <span class="inline-block px-3 py-1 rounded-full text-sm font-medium mt-1" :class="{
                        'bg-green-100 text-green-800': periodStatus === 'open',
                        'bg-yellow-100 text-yellow-800': periodStatus === 'closed',
                        'bg-gray-100 text-gray-800': periodStatus === 'archived'
                    }" x-text="periodStatusText"></span>
                </div>
                <div class="flex gap-2">
                    <template x-if="transaction?.can_be_edited">
                        <a :href="`/treasury/transacoes/${transaction?.id}/editar/`"
                           class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg">
                            Editar
                        </a>
                    </template>
                    <template x-if="transaction?.can_be_reversed">
                        <a :href="`/treasury/transacoes/${transaction?.id}/estornar/`"
                           class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">
                            Estornar
                        </a>
                    </template>
                </div>
            </div>
        </div>

        <!-- Reversals History -->
        <div x-show="reversals.length > 0" class="bg-white rounded-lg shadow">
            <div class="p-4 border-b">
                <h2 class="text-lg font-bold">Histórico de Estornos</h2>
            </div>
            <div class="divide-y">
                <template x-for="rev in reversals" :key="rev.id">
                    <div class="p-4 hover:bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium text-red-600">Estorno</p>
                                <p class="text-sm text-gray-600" x-text="rev.reason"></p>
                                <p class="text-xs text-gray-400" x-text="formatDateTime(rev.created_at)"></p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-500">Por: <span x-text="rev.created_by?.username"></span></p>
                                <p x-show="rev.authorized_by" class="text-sm text-gray-500">Autorizado por: <span x-text="rev.authorized_by?.username"></span></p>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>

<script>
function transactionDetail() {
    return {
        transaction: null,
        reversals: [],
        loading: true,
        periodStatus: 'open',
        periodStatusText: '',

        async init() {
            const id = window.location.pathname.split('/').slice(-2, -1)[0];
            await this.loadTransaction(id);
            await this.loadReversals(id);
        },

        async loadTransaction(id) {
            try {
                const response = await fetch(`/treasury/api/transactions/${id}/`, {
                    headers: { 'X-CSRFToken': this.getCookie('csrftoken') }
                });
                this.transaction = await response.json();
                this.periodStatus = this.transaction.accounting_period?.status || 'open';
                this.periodStatusText = {
                    'open': 'Aberto - Pode editar',
                    'closed': 'Fechado - Apenas estorno',
                    'archived': 'Arquivado - Requer autorização'
                }[this.periodStatus] || 'Desconhecido';
            } catch (error) {
                console.error('Error loading transaction:', error);
            } finally {
                this.loading = false;
            }
        },

        async loadReversals(id) {
            try {
                const response = await fetch(`/treasury/api/transactions/${id}/reversals/`, {
                    headers: { 'X-CSRFToken': this.getCookie('csrftoken') }
                });
                const data = await response.json();
                this.reversals = data.results || data;
            } catch (error) {
                console.error('Error loading reversals:', error);
            }
        },

        getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        },

        formatBRL(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        },

        formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('pt-BR');
        },

        formatDateTime(dateStr) {
            return new Date(dateStr).toLocaleString('pt-BR');
        }
    };
}
</script>
{% endblock %}
