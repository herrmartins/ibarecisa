{% extends "treasury/base.html" %}

{% load static %}

{% block treasury_content %}
<div class="container mx-auto px-4 py-6" x-data="periodDetail()">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <a href="{% url 'treasury:period-list' %}" class="text-blue-600 hover:text-blue-800">← Voltar para Períodos</a>
            <h1 class="text-2xl font-bold text-gray-800 mt-2" x-text="period?.month_name + '/' + period?.year"></h1>
        </div>
        <div class="flex gap-2">
            <template x-if="period?.status === 'open'">
                <button @click="closePeriod" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg">
                    Fechar Período
                </button>
            </template>
            <template x-if="period?.status === 'closed'">
                <button @click="reopenPeriod" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                    Reabrir
                </button>
            </template>
        </div>
    </div>

    <!-- Loading -->
    <div x-show="loading" class="flex justify-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>

    <!-- Period Content -->
    <div x-show="!loading && period">
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <p class="text-sm text-gray-500">Status</p>
                <span class="inline-block px-3 py-1 rounded-full text-sm font-medium mt-1" :class="{
                    'bg-green-100 text-green-800': period.status === 'open',
                    'bg-yellow-100 text-yellow-800': period.status === 'closed',
                    'bg-gray-100 text-gray-800': period.status === 'archived'
                }" x-text="period.status_label"></span>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <p class="text-sm text-gray-500">Saldo Inicial</p>
                <p class="text-xl font-bold text-gray-800" x-text="formatBRL(period.opening_balance)"></p>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <p class="text-sm text-gray-500">Saldo Final</p>
                <p class="text-xl font-bold" :class="(period.closing_balance || calculatedBalance) >= 0 ? 'text-green-600' : 'text-red-600'"
                   x-text="formatBRL(period.closing_balance || calculatedBalance || 0)"></p>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <p class="text-sm text-gray-500">Variação</p>
                <p class="text-xl font-bold" :class="(period.transactions_summary?.net || 0) >= 0 ? 'text-green-600' : 'text-red-600'"
                   x-text="formatBRL(period.transactions_summary?.net || 0)"></p>
            </div>
        </div>

        <!-- Transactions Summary -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <p class="text-sm text-green-600 font-medium">Receitas</p>
                <p class="text-2xl font-bold text-green-700" x-text="formatBRL(period.transactions_summary?.total_positive || 0)"></p>
                <p class="text-sm text-green-600" x-text="(period.transactions_summary?.positive_count || 0) + ' transações'"></p>
            </div>
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <p class="text-sm text-red-600 font-medium">Despesas</p>
                <p class="text-2xl font-bold text-red-700" x-text="formatBRL(period.transactions_summary?.total_negative || 0)"></p>
                <p class="text-sm text-red-600" x-text="(period.transactions_summary?.negative_count || 0) + ' transações'"></p>
            </div>
            <div class="bg-white border rounded-lg p-4">
                <p class="text-sm text-gray-500">Total de Transações</p>
                <p class="text-2xl font-bold text-gray-800" x-text="period.transactions_summary?.count || 0"></p>
            </div>
        </div>

        <!-- Transactions by Category -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-bold mb-4">Transações por Categoria</h2>
            <div class="space-y-3" x-show="categories.length > 0">
                <template x-for="cat in categories" :key="cat.name">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                        <span class="font-medium" x-text="cat.name"></span>
                        <div class="flex items-center gap-4">
                            <span class="text-sm text-green-600" x-show="cat.total_positive > 0" x-text="'+' + formatBRL(cat.total_positive)"></span>
                            <span class="text-sm text-red-600" x-show="cat.total_negative > 0" x-text="'-' + formatBRL(cat.total_negative)"></span>
                            <span class="text-sm font-bold" x-text="cat.count + ' tx'"></span>
                        </div>
                    </div>
                </template>
            </div>
            <p x-show="categories.length === 0" class="text-gray-500 text-center py-4">Nenhuma transação neste período</p>
        </div>

        <!-- Period Transactions -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-lg font-bold">Transações do Período</h2>
                <a :href="`/treasury/transacoes/?period=${period.id}`" class="text-blue-600 hover:text-blue-800 text-sm">
                    Ver todas →
                </a>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descrição</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Categoria</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Valor</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="tx in transactions" :key="tx.id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm" x-text="formatDate(tx.date)"></td>
                                <td class="px-6 py-4 text-sm" x-text="tx.description"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="tx.category?.name || '-'"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium"
                                    :class="tx.is_positive ? 'text-green-600' : 'text-red-600'"
                                    x-text="formatBRL(tx.amount)"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Close Modal -->
    <div x-show="showCloseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4" @click.away="showCloseModal = false">
            <h3 class="text-lg font-bold mb-4">Fechar Período</h3>
            <p class="text-gray-600 mb-4">
                Ao fechar o período, as transações não poderão mais ser editadas ou excluídas.
            </p>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                <textarea x-model="closeNotes" rows="3" class="w-full rounded-md border-gray-300 shadow-sm"></textarea>
            </div>
            <div class="flex justify-end gap-2">
                <button @click="showCloseModal = false" class="px-4 py-2 text-gray-600">Cancelar</button>
                <button @click="confirmClose" class="px-4 py-2 bg-yellow-500 text-white rounded">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<script>
function periodDetail() {
    return {
        period: null,
        transactions: [],
        categories: [],
        loading: true,
        showCloseModal: false,
        closeNotes: '',
        calculatedBalance: 0,

        async init() {
            const periodId = window.location.pathname.split('/').slice(-2, -1)[0];
            await this.loadPeriod(periodId);
            await this.loadTransactions(periodId);
        },

        async loadPeriod(id) {
            try {
                const response = await fetch(`/treasury/api/periods/${id}/`, {
                    headers: { 'X-CSRFToken': this.getCookie('csrftoken') }
                });
                this.period = await response.json();
                this.period.status_label = { 'open': 'Aberto', 'closed': 'Fechado', 'archived': 'Arquivado' }[this.period.status];
                this.calculatedBalance = this.period.opening_balance + (this.period.transactions_summary?.net || 0);
            } catch (error) {
                console.error('Error loading period:', error);
            } finally {
                this.loading = false;
            }
        },

        async loadTransactions(id) {
            try {
                const response = await fetch(`/treasury/api/periods/${id}/transactions/`, {
                    headers: { 'X-CSRFToken': this.getCookie('csrftoken') }
                });
                const data = await response.json();
                this.transactions = data.results || data;
                this.calculateCategories();
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        },

        calculateCategories() {
            const cats = {};
            this.transactions.forEach(tx => {
                const name = tx.category?.name || 'Sem categoria';
                if (!cats[name]) {
                    cats[name] = { name, total_positive: 0, total_negative: 0, count: 0 };
                }
                if (tx.is_positive) {
                    cats[name].total_positive += tx.amount;
                } else {
                    cats[name].total_negative += tx.amount;
                }
                cats[name].count++;
            });
            this.categories = Object.values(cats).sort((a, b) => b.count - a.count);
        },

        closePeriod() {
            this.showCloseModal = true;
        },

        async confirmClose() {
            try {
                const response = await fetch(`/treasury/api/periods/${this.period.id}/close/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': this.getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ notes: this.closeNotes })
                });
                if (response.ok) {
                    this.showCloseModal = false;
                    await this.loadPeriod(this.period.id);
                    this.$store.ui.toast('Período fechado com sucesso!');
                }
            } catch (error) {
                console.error('Error closing period:', error);
            }
        },

        async reopenPeriod() {
            if (!confirm('Reabrir este período?')) return;
            try {
                const response = await fetch(`/treasury/api/periods/${this.period.id}/reopen/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': this.getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    await this.loadPeriod(this.period.id);
                    this.$store.ui.toast('Período reaberto!');
                }
            } catch (error) {
                console.error('Error reopening period:', error);
            }
        },

        getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        },

        formatBRL(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        },

        formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('pt-BR');
        }
    };
}
</script>
{% endblock %}
