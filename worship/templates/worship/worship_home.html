{% extends 'core/base.html' %}
{% block content %}
<div class="container text-center" x-data="{ query: '', results: {}, showModal : false }">
  <p class="fs-1">Departamento de Música</p>
  <button type="button" class="btn btn-primary rounded-circle" 
  style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; font-size: 24px;"
  data-bs-toggle="modal" data-bs-target="#addSongModal">
+
</button>
  <!-- Search input -->
  <div class="d-flex justify-content-center">
      <div class="input-group input-group-lg">
          <input type="text" class="form-control" placeholder="Busca uma canção..."
                 x-model="query"
                 x-on:input.debounce.300ms="
                     fetch('{% url 'worship:song-search' %}?q=' + encodeURIComponent(query))
                         .then(response => response.json())
                         .then(data => results = data)
                 ">
      </div>
  </div>

  <!-- Responsive Results Display -->
  <div class="mt-4 row">
      <!-- Results by Title and Artist (Left Column) -->
      <div class="col-lg-6 mb-4">
          <!-- Results by Title -->
          <div class="result-category" x-show="results.title_matches && results.title_matches.length > 0">
              <p class="fs-3">Resultados por Título</p>
              <table class="table table-striped table-sm">
                  <thead>
                      <tr>
                          <th scope="col">Título</th>
                          <th scope="col">Artista</th>
                      </tr>
                  </thead>
                  <tbody>
                      <template x-for="song in results.title_matches" :key="song.id">
                          <tr>
                              <td x-text="song.title" class="fw-bold"></td>
                              <td x-text="song.artist"></td>
                          </tr>
                      </template>
                  </tbody>
              </table>
          </div>

          <!-- Results by Artist -->
          <div class="result-category" x-show="results.artist_matches && results.artist_matches.length > 0">
              <p class="fs-3">Resultados por Artista</p>
              <table class="table table-striped table-sm">
                  <thead>
                      <tr>
                          <th scope="col">Título</th>
                          <th scope="col">Artista</th>
                      </tr>
                  </thead>
                  <tbody>
                      <template x-for="song in results.artist_matches" :key="song.id">
                          <tr>
                              <td x-text="song.title"></td>
                              <td x-text="song.artist" class="fw-bold"></td>
                          </tr>
                      </template>
                  </tbody>
              </table>
          </div>
      </div>

      <!-- Results by Lyrics and Theme (Right Column) -->
      <div class="col-lg-6 mb-4">
          <!-- Results by Lyrics -->
          <div class="result-category" x-show="results.lyrics_matches && results.lyrics_matches.length > 0">
            <p class="fs-3">Resultados por Letra</p>
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                      <th scope="col" style="width: 30%;">Título</th>
                        <th scope="col">Trecho</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="song in results.lyrics_matches" :key="song.id">
                        <tr>
                            <td x-text="song.title"></td>
                            <td x-html="song.snippet"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>             

          <!-- Results by Theme -->
          <div class="result-category" x-show="results.theme_matches && results.theme_matches.length > 0">
              <p class="fs-3">Resultados por Tema</p>
              <table class="table table-striped table-sm">
                  <thead>
                      <tr>
                          <th scope="col">Título</th>
                          <th scope="col">Tema</th>
                      </tr>
                  </thead>
                  <tbody>
                      <template x-for="song in results.theme_matches" :key="song.id">
                          <tr>
                              <td x-text="song.title"></td>
                              <td x-text="song.theme" class="fw-bold"></td>
                          </tr>
                      </template>
                  </tbody>
              </table>
          </div>
      </div>
  </div>
</div>

<div class="modal fade" id="addSongModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title">Adicionar nova canção</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
              <form x-data="{ title: '', artist: '', theme: '', lyrics: '' }" x-on:submit.prevent="submitForm">
                  <div class="row">
                      <!-- Left Column: Title, Artist, and Theme -->
                      <div class="col-md-6">
                          <div class="mb-3">
                              <label for="songTitle" class="form-label">Título</label>
                              <input type="text" id="songTitle" class="form-control" x-model="title" required>
                          </div>
                          <div class="mb-3">
                            <div x-data="{ search: '', selectedArtist: '', isOpen: false, artists: ['Artist 1', 'Artist 2', 'Artist 3', 'Artist 4'] }">
                              <label for="artistSearch" class="form-label">Artista</label>
                              <input type="text" x-model="search" placeholder="Search artist..." @focus="isOpen = true" @click.away="isOpen = false"
                              class="form-control">
                              <div x-show="isOpen" class="dropdown-menu show" style="display: block; max-height: 200px; overflow-y: auto;">
                                  <template x-for="artist in artists.filter(a => a.toLowerCase().includes(search.toLowerCase()))" :key="artist">
                                      <div @click="selectedArtist = artist; isOpen = false" class="dropdown-item" x-text="artist"></div>
                                  </template>
                              </div>
                          </div>
                          
                          </div>
                          <div class="mb-3">
                            <div x-data="{ 
                              search: '', 
                              selectedTheme: '', 
                              isOpen: false, 
                              themes: [], 
                              async fetchThemes() {
                                  const response = await fetch('{% url "worship:theme-list" %}?q=' + encodeURIComponent(this.search));
                                  const data = await response.json();
                                  this.themes = data.results; // Adjust based on your API response format
                              },
                              init() {
                                  this.fetchThemes();
                                  this.$watch('search', (value) => {
                                  this.isOpen = true;
                                  this.fetchThemes();
                                  });
                              }
                          }">
                            <label for="themeSearch" class="form-label">Tema</label>
                            <input type="text" x-model="search" placeholder="Search theme..." 
                                  @focus="isOpen = true" @click.away="isOpen = false" class="form-control">
                        
                            <div x-show="isOpen" class="dropdown-menu show" style="display: block; max-height: 200px; overflow-y: auto;">
                                <template x-for="theme in themes" :key="theme.id">
                                    <div @click="selectedTheme = theme.text; isOpen = false" class="dropdown-item" x-text="theme.text"></div>
                                </template>
                            </div>
                        
                            <!-- Hidden input for storing the selected theme -->
                            <input type="hidden" x-model="selectedTheme">
                          </div>
                        </div>
                      </div>

                      <!-- Right Column: Lyrics -->
                      <div class="col-md-6">
                          <div class="mb-3">
                              <label for="songLyrics" class="form-label">Letra</label>
                              <textarea id="songLyrics" class="form-control" x-model="lyrics" rows="8"></textarea>
                          </div>
                      </div>
                  </div>
                  <button type="submit" class="btn btn-primary">Salvar</button>
              </form>
          </div>
          </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
