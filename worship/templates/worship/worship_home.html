{% extends 'core/base.html' %}
{% block content %}
<div class="container text-center" x-data="{ query: '', results: {}, showModal : false }">
  <p class="fs-1">Departamento de Música</p>
  <button type="button" class="btn btn-primary rounded-circle" 
  style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; font-size: 24px;"
  data-bs-toggle="modal" data-bs-target="#addSongModal">
+
</button>
  <!-- Search input -->
  <div class="d-flex justify-content-center">
      <div class="input-group input-group-lg">
          <input type="text" class="form-control" placeholder="Busca uma canção..."
                 x-model="query"
                 x-on:input.debounce.300ms="
                     fetch('{% url 'worship:song-search' %}?q=' + encodeURIComponent(query))
                         .then(response => response.json())
                         .then(data => results = data)
                 ">
      </div>
  </div>

  <!-- Responsive Results Display -->
  <div class="mt-4 row">
      <!-- Results by Title and Artist (Left Column) -->
      <div class="col-lg-6 mb-4">
          <!-- Results by Title -->
          <div class="result-category" x-show="results.title_matches && results.title_matches.length > 0">
              <p class="fs-3">Resultados por Título</p>
              <table class="table table-striped table-sm">
                  <thead>
                      <tr>
                          <th scope="col">Título</th>
                          <th scope="col">Artista</th>
                      </tr>
                  </thead>
                  <tbody>
                      <template x-for="song in results.title_matches" :key="song.id">
                          <tr>
                              <td x-text="song.title" class="fw-bold"></td>
                              <td x-text="song.artist"></td>
                          </tr>
                      </template>
                  </tbody>
              </table>
          </div>

          <!-- Results by Artist -->
          <div class="result-category" x-show="results.artist_matches && results.artist_matches.length > 0">
              <p class="fs-3">Resultados por Artista</p>
              <table class="table table-striped table-sm">
                  <thead>
                      <tr>
                          <th scope="col">Título</th>
                          <th scope="col">Artista</th>
                      </tr>
                  </thead>
                  <tbody>
                      <template x-for="song in results.artist_matches" :key="song.id">
                          <tr>
                              <td x-text="song.title"></td>
                              <td x-text="song.artist" class="fw-bold"></td>
                          </tr>
                      </template>
                  </tbody>
              </table>
          </div>
      </div>

      <!-- Results by Lyrics and Theme (Right Column) -->
      <div class="col-lg-6 mb-4">
          <!-- Results by Lyrics -->
          <div class="result-category" x-show="results.lyrics_matches && results.lyrics_matches.length > 0">
            <p class="fs-3">Resultados por Letra</p>
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                      <th scope="col" style="width: 30%;">Título</th>
                        <th scope="col">Trecho</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="song in results.lyrics_matches" :key="song.id">
                        <tr>
                            <td x-text="song.title"></td>
                            <td x-html="song.snippet"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>             

          <!-- Results by Theme -->
          <div class="result-category" x-show="results.theme_matches && results.theme_matches.length > 0">
              <p class="fs-3">Resultados por Tema</p>
              <table class="table table-striped table-sm">
                  <thead>
                      <tr>
                          <th scope="col">Título</th>
                          <th scope="col">Tema</th>
                      </tr>
                  </thead>
                  <tbody>
                      <template x-for="song in results.theme_matches" :key="song.id">
                          <tr>
                              <td x-text="song.title"></td>
                              <td x-text="song.theme" class="fw-bold"></td>
                          </tr>
                      </template>
                  </tbody>
              </table>
          </div>
      </div>
  </div>
</div>
<div class="modal fade" id="addSongModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adicionar nova canção</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Main Alpine Component for Form Submission -->
                <form x-data="{ 
                    title: '', 
                    artist: '', 
                    theme: '', 
                    hymnal: '', 
                    lyrics: '', 
                    submitForm() {
                        fetch('{% url 'worship:song-add' %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({
                                title: this.title,
                                artist: this.artist,
                                theme: this.theme,
                                hymnal: this.hymnal,
                                lyrics: this.lyrics
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('Song added successfully!');
                                this.resetForm();
                            } else {
                                alert('Error: ' + (data.error || 'Unknown error'));
                            }
                        })
                        .catch(error => alert('Submission failed: ' + error.message));
                    },
                    resetForm() {
                        this.title = '';
                        this.artist = '';
                        this.theme = '';
                        this.hymnal = '';
                        this.lyrics = '';
                    } 
                }"
                @artist-selected.window="artist = $event.detail"
                @theme-selected.window="theme = $event.detail"
                @hymnal-selected.window="hymnal = $event.detail"
                >
                    <div class="row">
                        <!-- Left Column: Title, Artist, Theme, and Hymnal -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="songTitle" class="form-label">Título</label>
                                <input type="text" id="songTitle" class="form-control" x-model="title" required>
                            </div>
                            
                            <!-- Hymnal Dropdown -->
                            <div class="mb-3" x-data="{ search: '', isOpen: false, hymnals: {{ hymnals|safe }} }">
                                <label for="hymnalSearch" class="form-label">Hinário</label>
                                <input type="text" x-model="search" placeholder="Busque o hinário..."
                                       @focus="isOpen = true" @click.away="isOpen = false" class="form-control">
                                <div x-show="isOpen" class="dropdown-menu show" style="display: block; max-height: 200px; overflow-y: auto;">
                                    <template x-for="hymnal in hymnals.filter(h => h.title.toLowerCase().includes(search.toLowerCase()))" :key="hymnal.id">
                                        <div @click="$dispatch('hymnal-selected', hymnal.title); search = hymnal.title; isOpen = false" 
                                             class="dropdown-item" x-text="hymnal.title"></div>
                                    </template>
                                </div>
                            </div>
  
                            <!-- Artist Dropdown -->
                            <div class="mb-3" x-data="{ search: '', isOpen: false, artists: [], async fetchArtists() {
                                const response = await fetch('{% url "worship:composer-list" %}?q=' + encodeURIComponent(this.search));
                                const data = await response.json();
                                this.artists = data.results;
                            },
                            init() {
                                this.fetchArtists();
                                this.$watch('search', () => {
                                    this.isOpen = true;
                                    this.fetchArtists();
                                });
                            } }">
                                <label for="artistSearch" class="form-label">Adorador</label>
                                <input type="text" x-model="search" placeholder="Busque um artista" 
                                       @focus="isOpen = true" @click.away="isOpen = false" class="form-control">
                                <div x-show="isOpen" class="dropdown-menu show" style="display: block; max-height: 200px; overflow-y: auto;">
                                    <template x-for="artist in artists" :key="artist.id">
                                        <div @click="$dispatch('artist-selected', artist.text); search = artist.text; isOpen = false" 
                                             class="dropdown-item" x-text="artist.text"></div>
                                    </template>
                                </div>
                            </div>
  
                            <!-- Theme Dropdown -->
                            <div class="mb-3" x-data="{ search: '', isOpen: false, themes: [], async fetchThemes() {
                                const response = await fetch('{% url "worship:theme-list" %}?q=' + encodeURIComponent(this.search));
                                const data = await response.json();
                                this.themes = data.results;
                            },
                            init() {
                                this.fetchThemes();
                                this.$watch('search', () => {
                                    this.isOpen = true;
                                    this.fetchThemes();
                                });
                            } }">
                                <label for="themeSearch" class="form-label">Tema</label>
                                <input type="text" x-model="search" placeholder="Busque um tema..." 
                                       @focus="isOpen = true" @click.away="isOpen = false" class="form-control">
                                <div x-show="isOpen" class="dropdown-menu show" style="display: block; max-height: 200px; overflow-y: auto;">
                                    <template x-for="theme in themes" :key="theme.id">
                                        <div @click="$dispatch('theme-selected', theme.text); search = theme.text; isOpen = false" 
                                             class="dropdown-item" x-text="theme.text"></div>
                                    </template>
                                </div>
                            </div>
                        </div>
  
                        <!-- Right Column: Lyrics -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="songLyrics" class="form-label">Letra</label>
                                <textarea id="songLyrics" class="form-control" x-model="lyrics" rows="8"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Button with @click to trigger submitForm -->
                    <button type="button" class="btn btn-primary" @click="submitForm">Salvar</button>
                </form>
            </div>
        </div>
      </div>
    </div>
  </div>
  
  

{% endblock %}
